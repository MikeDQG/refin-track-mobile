import 'package:app/firebase/save_stroj.dart';
import 'package:app/models/stroj.dart';
import 'package:app/widgets/attribute_row.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:flutter/material.dart';

class DetailsPage extends StatefulWidget {
  final Stroj stroj;

  DetailsPage({required this.stroj});

  @override
  State<DetailsPage> createState() => _DetailsPageState();
}

class _DetailsPageState extends State<DetailsPage> {
  bool isEditing = false;
  bool isNewRecord = false;
  late Stroj localStroj;
  bool isLoading = true;

  @override
  void initState() {
    super.initState();
    localStroj = Stroj(
      id: widget.stroj.id,
      naziv: widget.stroj.naziv,
      opis: widget.stroj.opis,
    );
    _initializeEditing();
  }

  Future<void> _initializeEditing() async {
    final existingStroj = await FirebaseStrojService.getStrojById(
      widget.stroj.id,
    );

    if (!mounted) return;

    setState(() {
      if (existingStroj != null) {
        localStroj.naziv = existingStroj.naziv;
        localStroj.opis = existingStroj.opis;
        isNewRecord = false;
        isEditing = false; // üî¥ THIS WAS MISSING
      } else {
        isNewRecord = true;
        isEditing = true;
      }
      isLoading = false;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Podrobnosti')),
      body: isLoading
          ? Center(child: CircularProgressIndicator())
          : Padding(
              padding: const EdgeInsets.all(8.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  EditableAttributeRow(
                    attributeName: 'Naziv',
                    attributeValue: localStroj.naziv,
                    isEditing: isEditing,
                    onChanged: (value) => localStroj.naziv = value,
                  ),
                  SizedBox(height: 8),
                  AttributeRow(
                    attributeName: '≈†tevilka',
                    attributeValue: localStroj.id.toString(),
                  ),
                  SizedBox(height: 8),
                  EditableAttributeRow(
                    attributeName: 'Opis',
                    isEditing: isEditing,
                    attributeValue: localStroj.opis ?? "/",
                    onChanged: (newValue) => localStroj.opis = newValue,
                  ),
                  SizedBox(height: 8),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      if (!isNewRecord) ...{
                        ElevatedButton(
                          onPressed: () {
                            setState(() {
                              isEditing = !isEditing;
                            });
                          },
                          child: Row(
                            children: [
                              if (isEditing) ...{
                                Text('Prekliƒçi urejanje'),
                                SizedBox(width: 8),
                                Icon(Icons.close),
                              } else ...{
                                Text('Uredi'),
                                SizedBox(width: 8),
                                Icon(Icons.edit),
                              },
                            ],
                          ),
                        ),
                        SizedBox(width: 16),
                        ElevatedButton(
                          onPressed: () async {
                            await FirebaseStrojService.deleteStroj(
                              localStroj.id,
                            );
                            Navigator.pop(context);
                          },
                          child: Row(
                            children: [
                              Text(
                                'Izbri≈°i stroj',
                                style: TextStyle(color: Colors.red),
                              ),
                              SizedBox(width: 8),
                              Icon(Icons.delete, color: Colors.red),
                            ],
                          ),
                        ),
                      },
                      if (isEditing && !isNewRecord) SizedBox(width: 16),
                      if (isEditing)
                        ElevatedButton(
                          onPressed: () async {
                            final Stroj editedStroj = Stroj(
                              id: localStroj.id,
                              naziv: localStroj.naziv,
                              opis: localStroj.opis,
                            );
                            final int _result = isNewRecord
                                ? await FirebaseStrojService.saveStroj(
                                    stroj: editedStroj,
                                  )
                                : await FirebaseStrojService.updateStroj(
                                    stroj: editedStroj,
                                  );
                            print('Saved stroj: $_result');
                            setState(() {
                              isEditing = !isEditing;
                              isNewRecord = false;
                            });
                          },
                          child: Row(
                            children: [
                              Text('Shrani'),
                              SizedBox(width: 8),
                              Icon(Icons.save),
                            ],
                          ),
                        ),
                    ],
                  ),
                  Divider(),
                ],
              ),
            ),
    );
  }
}
